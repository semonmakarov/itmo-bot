import json
import time
import requests
from typing import List, Dict

# Конфигурация
API_URL = "http://localhost:8000/api/request"
OUTPUT_FILE = "itmo_qa_dataset.json"
DELAY_BETWEEN_REQUESTS = 1  # в секундах

questions = [
    {
        "id": 1,
        "query": "В каком году был основан Университет ИТМО?\n1. 1899\n2. 1900\n3. 1930\n4. 1957"
    },
    {
        "id": 2,
        "query": "Сколько раз команда ИТМО выигрывала чемпионат мира по программированию ICPC?\n1. 5\n2. 7\n3. 9\n4. 11"
    },
    {
        "id": 3,
        "query": "В каком районе Санкт-Петербурга расположен главный кампус ИТМО?\n1. Петроградский\n2. Калининский\n3. Василеостровский\n4. Невский"
    },
    {
        "id": 4,
        "query": "Какой факультет НЕ входит в состав ИТМО?\n1. Факультет фотоники\n2. Факультет искусственного интеллекта\n3. Факультет робототехники\n4. Факультет биотехнологий"
    },
    {
        "id": 5,
        "query": "Какое из этих направлений НЕ является приоритетным для ИТМО?\n1. Квантовые технологии\n2. Гастрономическая физика\n3. Нейротехнологии\n4. Умные материалы"
    },
    {
        "id": 6,
        "query": "Какие новые образовательные программы запустил ИТМО в 2023 году?"
    },
    {
        "id": 7,
        "query": "В каком предметном рейтинге QS ИТМО входит в топ-100?\n1. Computer Science\n2. Физика\n3. Математика\n4. Инженерия"
    },
    {
        "id": 8,
        "query": "С каким IT-гигантом у ИТМО есть совместная магистерская программа?\n1. Яндекс\n2. Google\n3. JetBrains\n4. 1С"
    },
    {
        "id": 9,
        "query": "Сколько общежитий имеет Университет ИТМО?\n1. 3\n2. 5\n3. 7\n4. 9"
    },
    {
        "id": 10,
        "query": "Какой из этих научных центров НЕ принадлежит ИТМО?\n1. Центр квантовых коммуникаций\n2. Центр AR/VR технологий\n3. Центр геномных исследований\n4. Центр урбанистики"
    },
    {
        "id": 11,
        "query": "Какой проект ИТМО связан с квантовыми технологиями?\n1. Российский квантовый центр\n2. Центр квантовых коммуникаций\n3. Лаборатория квантового ИИ\n4. Квантовый вычислительный кластер"
    },
    {
        "id": 12,
        "query": "Какое достижение ИТМО в области фотоники?\n1. Создание квантового компьютера\n2. Разработка фотонных чипов\n3. Изобретение лазера\n4. Создание OLED-дисплеев"
    },
    {
        "id": 13,
        "query": "Какой факультет ИТМО самый старый?\n1. Фотоника\n2. Компьютерные технологии\n3. Системы управления\n4. Точная механика"
    },
    {
        "id": 14,
        "query": "Какая компания сотрудничает с ИТМО в области ИИ?\n1. Tesla\n2. Samsung\n3. Huawei\n4. Яндекс"
    },
    {
        "id": 15,
        "query": "Какой индекс цитирования у ИТМО?\n1. Выше среднего по России\n2. Самый высокий в стране\n3. Средний по Европе\n4. Не публикуется"
    },
    {
        "id": 16,
        "query": "Какая программа ИТМО в области искусственного интеллекта?\n1. DeepMind\n2. AI Research Center\n3. Центр Нейронаук\n4. Лаборатория машинного обучения"
    },
    {
        "id": 17,
        "query": "Какой процент иностранных студентов в ИТМО?\n1. 5-10%\n2. 15-20%\n3. 25-30%\n4. Более 40%"
    },
    {
        "id": 18,
        "query": "Какая лаборатория ИТМО известна в области робототехники?\n1. Лаборатория Boston Dynamics\n2. Центр робототехники\n3. Лаборатория антропоморфных систем\n4. Центр промышленной автоматизации"
    },
    {
        "id": 19,
        "query": "Какой проект ИТМО связан с умным городом?\n1. SmartITMO\n2. Умный кампус\n3. Цифровой двойник\n4. Урбанистический хаб"
    },
    {
        "id": 20,
        "query": "Какое событие ИТМО проводит ежегодно?\n1. Хакерскую олимпиаду\n2. Фестиваль света\n3. Международный форум AI\n4. Киберспортивный турнир"
    }
]

def send_request(question: Dict) -> Dict:
    """Отправляет вопрос на API и возвращает ответ"""
    try:
        response = requests.post(
            API_URL,
            json={
                "query": question["query"],
                "id": question["id"]
            },
            headers={"Content-Type": "application/json"}
        )
        return response.json()
    except Exception as e:
        print(f"Ошибка при обработке вопроса {question['id']}: {str(e)}")
        return None

def generate_dataset(questions: List[Dict]) -> List[Dict]:
    """Генерирует датасет с ответами"""
    dataset = []
    
    for question in questions:
        print(f"Обрабатывается вопрос {question['id']}...")
        
        # Отправка запроса
        response = send_request(question)
        
        if response:
            dataset.append({
                "id": question["id"],
                "question": question["query"],
                "answer": response.get("answer"),
                "reasoning": response.get("reasoning"),
                "sources": response.get("sources", [])
            })
        
        time.sleep(DELAY_BETWEEN_REQUESTS)
    
    return dataset

def save_to_file(dataset: List[Dict], filename: str):
    """Сохраняет датасет в JSON-файл"""
    with open(filename, "w", encoding="utf-8") as f:
        json.dump(dataset, f, ensure_ascii=False, indent=2)

if __name__ == "__main__":
    print("Начало генерации датасета...")
    dataset = generate_dataset(questions)
    save_to_file(dataset, OUTPUT_FILE)
    print(f"Готово! Результаты сохранены в {OUTPUT_FILE}")
    print(f"Обработано вопросов: {len(dataset)}/{len(questions)}")