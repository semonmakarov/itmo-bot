import asyncio
import aiohttp
import json
import time
from typing import List, Dict

# Конфигурация
API_URL = "http://130.193.59.4:80/api/request"
OUTPUT_FILE = "test/test_dataset.json"
DELAY_BETWEEN_REQUESTS = 1  # в секундах

questions = [
    # {
    #     "id": 1,
    #     "query": "В каком году был основан Университет ИТМО?\n1. 1899\n2. 1900\n3. 1930\n4. 1957"
    # },
    # {
    #     "id": 2,
    #     "query": "Сколько раз команда ИТМО выигрывала чемпионат мира по программированию ICPC?\n1. 5\n2. 7\n3. 9\n4. 11"
    # },
    # {
    #     "id": 3,
    #     "query": "В каком районе Санкт-Петербурга расположен главный кампус ИТМО?\n1. Петроградский\n2. Калининский\n3. Василеостровский\n4. Невский"
    # },
    # {
    #     "id": 4,
    #     "query": "Какой факультет НЕ входит в состав ИТМО?\n1. Факультет фотоники\n2. Факультет искусственного интеллекта\n3. Факультет робототехники\n4. Факультет биотехнологий"
    # },
    # {
    #     "id": 5,
    #     "query": "Какое из этих направлений НЕ является приоритетным для ИТМО?\n1. Квантовые технологии\n2. Гастрономическая физика\n3. Нейротехнологии\n4. Умные материалы"
    # },
    # {
    #     "id": 6,
    #     "query": "В каком предметном рейтинге QS ИТМО входит в топ-100?\n1. Computer Science\n2. Физика\n3. Математика\n4. Инженерия"
    # }
    # {
    #     "id": 7,
    #     "query": "С каким IT-гигантом у ИТМО есть совместная магистерская программа?\n1. Яндекс\n2. Google\n3. JetBrains\n4. 1С"
    # },
    # {
    #     "id": 8,
    #     "query": "Сколько общежитий имеет Университет ИТМО?\n1. 3\n2. 5\n3. 7\n4. 9"
    # },
    # {
    #     "id": 9,
    #     "query": "Какой из этих научных центров НЕ принадлежит ИТМО?\n1. Центр квантовых коммуникаций\n2. Центр AR/VR технологий\n3. Центр геномных исследований\n4. Центр урбанистики"
    # },
    # {
    #     "id": 10,
    #     "query": "Какой проект ИТМО связан с квантовыми технологиями?\n1. Российский квантовый центр\n2. Центр квантовых коммуникаций\n3. Лаборатория квантового ИИ\n4. Квантовый вычислительный кластер"
    # },
    # {
    #     "id": 11,
    #     "query": "Какое достижение ИТМО в области фотоники?\n1. Создание квантового компьютера\n2. Разработка фотонных чипов\n3. Изобретение лазера\n4. Создание OLED-дисплеев"
    # },
    # {
    #     "id": 12,
    #     "query": "Какой факультет ИТМО самый старый?\n1. Фотоника\n2. Компьютерные технологии\n3. Системы управления\n4. Точная механика"
    # },
    # {
    #     "id": 13,
    #     "query": "Какая компания сотрудничает с ИТМО в области ИИ?\n1. Tesla\n2. Samsung\n3. Huawei\n4. Яндекс"
    # },
    # {
    #     "id": 14,
    #     "query": "Какой процент иностранных студентов в ИТМО?\n1. 5-10%\n2. 15-20%\n3. 25-30%\n4. Более 40%"
    # },
    # {
    #     "id": 15,
    #     "query": "Какое событие ИТМО проводит ежегодно?\n1. Хакерскую олимпиаду\n2. Фестиваль света\n3. Международный форум AI\n4. Киберспортивный турнир"
    # },
    # {
    #     "id": 16,
    #     "query": "Расскажите о последних достижениях ИТМО в области квантовых технологий."
    # },
    # {
    #     "id": 17,
    #     "query": "Какие международные партнерства есть у ИТМО?"
    # },
    # {
    #     "id": 18,
    #     "query": "Опишите основные направления исследований в ИТМО."
    # },
    # {
    #     "id": 19,
    #     "query": "Какие инновационные образовательные программы предлагает ИТМО?"
    # },
    # {
    #     "id": 20,
    #     "query": "Расскажите о стартап-экосистеме ИТМО и наиболее успешных проектах."
    # },
    {
        "id": 21,
        "query": "Какой известный физик был почетным доктором ИТМО?\n1. Альберт Эйнштейн\n2. Жорес Алфёров\n3. Стивен Хокинг\n4. Лев Ландау"
    },
    {
        "id": 22,
        "query": "В каком году ИТМО получил статус национального исследовательского университета?\n1. 2000\n2. 2005\n3. 2009\n4. 2015"
    },
    {
        "id": 23,
        "query": "Какой из этих проектов НЕ связан с ИТМО?\n1. Кронверк\n2. ITMO.STARS\n3. Art&Science\n4. Сколково"
    },
    {
        "id": 24,
        "query": "Какой язык программирования был разработан в ИТМО?\n1. Python\n2. Java\n3. DRAKON\n4. C++"
    },
    {
        "id": 25,
        "query": "Какое место занимает ИТМО в рейтинге THE по компьютерным наукам?\n1. Топ-50\n2. Топ-100\n3. Топ-200\n4. Топ-300"
    },
    {
        "id": 26,
        "query": "Расскажите о международных летних школах, проводимых ИТМО."
    },
    {
        "id": 27,
        "query": "Какие проекты ИТМО связаны с развитием искусственного интеллекта?"
    },
    {
        "id": 28,
        "query": "Опишите основные направления работы Института дизайна и урбанистики ИТМО."
    },
    {
        "id": 29,
        "query": "Какие меры предпринимает ИТМО для поддержки студенческого предпринимательства?"
    },
    {
        "id": 30,
        "query": "Расскажите о сотрудничестве ИТМО с ведущими IT-компаниями России."
    },
    {
        "id": 31,
        "query": "Какой известный выпускник ИТМО стал лауреатом премии Филдса?\n1. Григорий Перельман\n2. Станислав Смирнов\n3. Андрей Окуньков\n4. Максим Концевич"
    },
    {
        "id": 32,
        "query": "Какое уникальное оборудование есть в лабораториях ИТМО?\n1. Квантовый компьютер\n2. Суперкомпьютер\n3. Нейроинтерфейс\n4. Термоядерный реактор"
    },
    {
        "id": 33,
        "query": "В каком году ИТМО впервые выиграл чемпионат мира по программированию ICPC?\n1. 2000\n2. 2004\n3. 2009\n4. 2012"
    },
    {
        "id": 34,
        "query": "Какой из этих проектов связан с ИТМО?\n1. Yandex.Lyceum\n2. Школа 21\n3. ITMO.KIDS\n4. Техносфера Mail.ru"
    },
    {
        "id": 35,
        "query": "Какой процент выпускников ИТМО трудоустраивается по специальности?\n1. 50-60%\n2. 70-80%\n3. 85-95%\n4. Более 95%"
    },
    {
        "id": 36,
        "query": "Опишите основные направления работы Института трансляционной медицины ИТМО."
    },
    {
        "id": 37,
        "query": "Какие проекты ИТМО связаны с развитием технологий виртуальной и дополненной реальности?"
    },
    {
        "id": 38,
        "query": "Расскажите о международных научных конференциях, организуемых ИТМО."
    },
    {
        "id": 39,
        "query": "Какие инициативы ИТМО направлены на развитие экологического сознания и устойчивого развития?"
    },
    {
        "id": 40,
        "query": "Опишите основные направления исследований ИТМО в области информационной безопасности и криптографии."
    }

]

async def send_request(session: aiohttp.ClientSession, query: str, qid: int) -> Dict:
    """Отправка асинхронного запроса к API"""
    try:
        payload = {
            "query": query,
            "id": qid
        }
        
        async with session.post(
            API_URL,
            json=payload,
            timeout=15
        ) as response:
            return await response.json()
            
    except Exception as e:
        print(f"Ошибка при обработке запроса {qid}: {str(e)}")
        return {
            "id": qid,
            "answer": None,
            "reasoning": f"Ошибка: {str(e)}",
            "sources": []
        }

async def process_batch(session: aiohttp.ClientSession, batch: List[Dict]) -> List[Dict]:
    """Обработка группы запросов"""
    tasks = [send_request(session, q["query"], q["id"]) for q in batch]
    return await asyncio.gather(*tasks)

async def generate_dataset() -> List[Dict]:
    """Генерация датасета с батчевой обработкой"""
    async with aiohttp.ClientSession() as session:
        results = []
        
        # Разбиваем вопросы на батчи по 3 для оптимальной нагрузки
        for i in range(0, len(questions), 3):
            batch = questions[i:i+3]
            batch_results = await process_batch(session, batch)
            results.extend(batch_results)
            await asyncio.sleep(DELAY_BETWEEN_REQUESTS)
            
        return results

def save_to_file(dataset: List[Dict], filename: str):
    """Сохранение результатов в JSON"""
    with open(filename, "w", encoding="utf-8") as f:
        json.dump(dataset, f, ensure_ascii=False, indent=2)

async def main():
    """Основная функция"""
    print("🚀 Запуск тестирования...")
    start_time = time.time()
    
    dataset = await generate_dataset()
    save_to_file(dataset, OUTPUT_FILE)
    
    elapsed_time = time.time() - start_time
    print(f"✅ Тестирование завершено! Результаты сохранены в {OUTPUT_FILE}")
    print(f"📊 Обработано вопросов: {len(dataset)}/{len(questions)}")
    print(f"⏱ Общее время выполнения: {elapsed_time:.2f} сек")

if __name__ == "__main__":
    asyncio.run(main())
